<script type="text/x-iobroker" data-template-name="iqontrol">
	<div class="row">
		<div class="input-field col s4">
			<input type="checkbox" data-field="enabled" data-default="false"/>
			<!-- this field is mandatory, just to find out if to include this settings or not</span-->
			<span class="translate">enabled</span>
		</div>
		<div class="input-field col s8">
			<input type="checkbox" class="enableOnChange" data-field="readonly">
			<span class="translate">Readonly</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="checkbox" class="enableOnChange" data-field="invert">
			<span class="translate">Invert</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for booleans and for numbers with defined min and max)</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="checkbox" class="enableOnChange" data-field="confirm">
			<span class="translate">Confirm</span>
			<br>
			<span class="translate" style="font-size: 75%;">(before sending a state a confirmation-box is showed)</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="text" class="enableOnChange" data-field="pincode">
			<span class="translate">PIN-Code</span>
			<br>
			<span class="translate" style="font-size: 75%;">(before sending a state you have to enter this code)</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="text" class="enableOnChange" data-field="unit">
			<span class="translate">Unit</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="text" class="enableOnChange" data-field="unit_zero">
			<span class="translate">Unit (if value is 0)</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for numbers)</span>			
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="text" class="enableOnChange" data-field="unit_one">
			<span class="translate">Unit (if value is 1)</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for numbers)</span>			
		</div>
	</div> 
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="number" class="enableOnChange" data-field="min">
			<span class="translate">Minimum</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for numbers)</span>			
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="number" class="enableOnChange" data-field="max">
			<span class="translate">Maximum</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for numbers)</span>			
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="number" class="enableOnChange" min="0" max="100000" step="0.0001" data-field="step">
			<span class="translate">Step</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for numbers)</span>			
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="number" class="enableOnChange" min="0" max="10" step="1" data-field="roundDigits">
			<span class="translate">Round to this number of digits</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported for numbers)</span>			
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s6">
			<input type="text" class="enableOnChange hasTemplate" data-field="timeFormat">
			<span class="translate">Format of Time (as stored in the datapoint, see readme)</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported if datapoint has the role time)</span>			
		</div>
		<div class="input-field col s2">
			<i class="material-icons" style="position: absolute; left: -5px; top: 13px;">keyboard_arrow_left</i>
            <select data-template-field="timeFormat" class="template" >
                <option value="" disabled selected 					class="translate">Templates</option>
                <option value="x"          							class="translate">Timestamp</option>
                <option value="YYYY-MM-DDTHH:mm:ss.SSSZ"          	class="translate">YYYY-MM-DDTHH:mm:ss.SSSZ</option>
                <option value="ddd MMM DD YYYY HH:mm:ss ZZ"         class="translate">ddd MMM DD YYYY HH:mm:ss ZZ</option>
                <option value="HH:mm"          						class="translate">HH:mm</option>
                <option value="HH:mm:ss"          					class="translate">HH:mm:ss</option>
                <option value="DD.MM.YYYY"          				class="translate">DD.MM.YYYY</option>
                <option value="DD.MM.YYYY HH:mm"          			class="translate">DD.MM.YYYY HH:mm</option>
                <option value="DD.MM.YYYY HH:mm:ss"          		class="translate">DD.MM.YYYY HH:mm:ss</option>
                <option value="ddd, DD.MM.YYYY"          			class="translate">ddd, DD.MM.YYYY</option>
                <option value="ddd, DD.MM.YYYY HH:mm"          		class="translate">ddd, DD.MM.YYYY HH:mm</option>
                <option value="ddd, DD.MM.YYYY HH:mm:ss"          	class="translate">ddd, DD.MM.YYYY HH:mm:ss</option>
                <option value="dddd, DD.MM.YYYY"          			class="translate"><dddd, DD.MM.YYYY/option>
                <option value="dddd, DD.MM.YYYY HH:mm"          	class="translate">dddd, DD.MM.YYYY HH:mm</option>
                <option value="dddd, DD.MM.YYYY HH:mm:ss"          	class="translate">dddd, DD.MM.YYYY HH:mm:ss</option>
                <option value="hh:mm a"          					class="translate">hh:mm a</option>
                <option value="hh:mm:ss a"          				class="translate">hh:mm:ss a</option>
                <option value="YYYY-MM-DD"          				class="translate">YYYY-MM-DD</option>
                <option value="YYYY-MM-DD hh:mm a"          		class="translate">YYYY-MM-DD hh:mm a</option>
                <option value="YYYY-MM-DD hh:mm:ss a"          		class="translate">YYYY-MM-DD hh:mm:ss a</option>
                <option value="ddd, YYYY-MM-DD"          			class="translate">ddd, YYYY-MM-DD</option>
                <option value="ddd, YYYY-MM-DD hh:mm a"          	class="translate">ddd, YYYY-MM-DD hh:mm a</option>
                <option value="ddd, YYYY-MM-DD hh:mm:ss a"          class="translate">ddd, YYYY-MM-DD hh:mm:ss a</option>
                <option value="dddd, YYYY-MM-DD"          			class="translate">dddd, YYYY-MM-DD</option>
                <option value="dddd, YYYY-MM-DD hh:mm a"          	class="translate">dddd, YYYY-MM-DD hh:mm a</option>
                <option value="dddd, YYYY-MM-DD hh:mm:ss a"			class="translate">dddd, YYYY-MM-DD hh:mm:ss a</option>
                <option value="P"          							class="translate">Period</option>
                <option value="Pms"          						class="translate">Period in milliseconds</option>
                <option value="Ps"          						class="translate">Period in seconds</option>
                <option value="Pm"          						class="translate">Period in minutes</option>
            </select>
            <span class="translate">Templates for Format of Time</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s6">
			<input type="text" class="enableOnChange hasTemplate" data-field="timeDisplayFormat">
			<span class="translate">Display-Format of Time (how it should be displayed, see readme)</span>
			<br>
			<span class="translate" style="font-size: 75%;">(this is only supported if datapoint has the role time)</span>			
		</div>
		<div class="input-field col s2">
			<i class="material-icons" style="position: absolute; left: -5px; top: 13px;">keyboard_arrow_left</i>
            <select data-template-field="timeDisplayFormat" class="template" >
                <option value="" disabled selected 					class="translate">Templates</option>
                <option value="HH:mm"          						class="translate">HH:mm</option>
                <option value="HH:mm:ss"          					class="translate">HH:mm:ss</option>
                <option value="DD.MM.YYYY"          				class="translate">DD.MM.YYYY</option>
                <option value="DD.MM.YYYY HH:mm"          			class="translate">DD.MM.YYYY HH:mm</option>
                <option value="DD.MM.YYYY HH:mm:ss"          		class="translate">DD.MM.YYYY HH:mm:ss</option>
                <option value="ddd, DD.MM.YYYY"          			class="translate">ddd, DD.MM.YYYY</option>
                <option value="ddd, DD.MM.YYYY HH:mm"          		class="translate">ddd, DD.MM.YYYY HH:mm</option>
                <option value="ddd, DD.MM.YYYY HH:mm:ss"       		class="translate">ddd, DD.MM.YYYY HH:mm:ss</option>
                <option value="dddd, DD.MM.YYYY"          			class="translate">dddd, DD.MM.YYYY</option>
                <option value="dddd, DD.MM.YYYY HH:mm"          	class="translate">dddd, DD.MM.YYYY HH:mm</option>
                <option value="dddd, DD.MM.YYYY HH:mm:ss"          	class="translate">dddd, DD.MM.YYYY HH:mm:ss</option>
                <option value="hh:mm a"          					class="translate">hh:mm a</option>
                <option value="hh:mm:ss a"          				class="translate">hh:mm:ss a</option>
                <option value="YYYY-MM-DD"          				class="translate">YYYY-MM-DD</option>
                <option value="YYYY-MM-DD hh:mm a"          		class="translate">YYYY-MM-DD hh:mm a</option>
                <option value="YYYY-MM-DD hh:mm:ss a"          		class="translate">YYYY-MM-DD hh:mm:ss a</option>
                <option value="ddd, YYYY-MM-DD"          			class="translate">ddd, YYYY-MM-DD</option>
                <option value="ddd, YYYY-MM-DD hh:mm a"          	class="translate">ddd, YYYY-MM-DD hh:mm a</option>
                <option value="ddd, YYYY-MM-DD hh:mm:ss a"          class="translate">ddd, YYYY-MM-DD hh:mm:ss a</option>
                <option value="dddd, YYYY-MM-DD"          			class="translate">dddd, YYYY-MM-DD</option>
                <option value="dddd, YYYY-MM-DD hh:mm a"          	class="translate">dddd, YYYY-MM-DD hh:mm a</option>
                <option value="dddd, YYYY-MM-DD hh:mm:ss a"         class="translate"></option>
                <option value="D [Day(s)], H:m:s"          			class="translate">D [Day(s)], H:m:s (for Periods)</option>
                <option value="D [Day(s)], HH:mm:ss"          		class="translate">D [Day(s)], HH:mm:ss (for Periods)</option>
            </select>
            <span class="translate">Templates for Display-Format of Time</span>
		</div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
        <div class="input-field col s8">
            <select data-field="type" class="enableOnChange " >
                <option value=""          		class="translate"></option>
                <option value="string"          class="translate">String</option>
                <option value="number"    		class="translate">Number</option>
                <option value="boolean"    		class="translate">Boolean</option>
                <!--option value="object"    	class="translate">Object</option-->
                <!--option value="array"    	class="translate">Array</option-->
                <!--option value="mixed"    	class="translate">Mixed</option-->
            </select>
            <span class="translate">Type</span>
			<br>
			<span class="translate" style="font-size: 75%;">(overwrites common.type property)</span>
        </div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
        <div class="input-field col s8">  
            <select data-field="role" class="enableOnChange">
                <option value=""          				class="translate"></option>
                <option value="state"    				class="translate">State (state)</option>
                <option value="level"    				class="translate">Level (level)</option>
                <option value="switch"    				class="translate">Switch (switch)</option>
                <option value="button"    				class="translate">Button (button)</option>
				<option value="sensor.window"    		class="translate">Window/Door sensor (sensor.window)</option>
                <option value="sensor.alarm"    		class="translate">Alarmsensor (sensor.alarm)</option>
                <option value="sensor.alarm.fire" 		class="translate">Firesensor (sensor.alarm.fire)</option>
                <option value="value.time" 				class="translate">Time (value.time)</option>
                <option value="level.timer" 				class="translate">Timer (level.timer)</option>
                <!--option value="indicator.state"      class="translate">Indicator (indicator.state)</option-->
            </select>
            <span class="translate">Role</span>
			<br>
			<span class="translate" style="font-size: 75%;">(overwrites common.role property)</span>
        </div>
	</div>
	<div class="row">
		<div class="col s4">
		</div>
		<div class="input-field col s8">
			<input type="text" class="enableOnChange" data-field="targetValueId">
			<span class="translate">Write target values to this Datapoint ID</span>
			<br>
			<span class="translate" style="font-size: 75%;">(if you have different data points for the actual and the target value)</span>
		</div>
	</div>
	<div class="row">
		<div class="col s12 tableStates">
			<div class="row">
				<h6 class="translate">Value-List:</h6>
			</div>
			<div class="row">
				<div class="col s2 m1 l1 center">
					<button title="Add" class="translateT table-button-add btn-floating waves-effect waves-light btn-small">
						<i class="material-icons">add</i>
					</button>
				</div>
			</div>
			<div class="col s12 m12 l12">
				<table class="table-values" style="width: 90%;">
					<thead>
						<tr>
							<th data-name="key" class="translate">Key</th>
							<th data-name="value" class="translate">Value</th>
							<th data-buttons="up down delete" style="width:150px;"></th>
						</tr>
					</thead>
					<tbody style="overflow: auto;"></tbody>
				</table>
			</div>
		</div>
	</div>
	<br>
	<div class="row">
		<div class="input-field col s12 m12 l12">
			<input type="checkbox" class="enableOnChange" data-field="statesAddInput">
			<span class="translate">Add option to enter free text</span>
		</div>
	</div>
	<div class="row">
		<div class="input-field col s12 m12 l12">
			<input type="text" class="enableOnChange" data-field="statesAddInputCaption">
			<span class="translate">Name of this option</span>
		</div>
	</div>
	<br>
	<div class="row">
		<div class="col s12 tableTargetValues">
			<div class="row">
				<h6 class="translate">Target-Value-List:</h6>
				<span class="translate" style="font-size: 75%;">(If the user enters one of these keys in iQontrol, the defined Target-Value will be sent to the defined Target-Datapoint ID)</span>
			</div>
			<div class="row">
				<div class="col s2 m1 l1 center">
					<button title="Add" class="translateT table-button-add btn-floating waves-effect waves-light btn-small">
						<i class="material-icons">add</i>
					</button>
				</div>
			</div>
			<div class="col s12 m12 l12">
				<table class="table-values" style="width: 90%;">
					<thead>
						<tr>
							<th data-name="key" class="translate">Key</th>
							<th data-name="value" class="translate">Target-Datapoint ID</th>
							<th data-name="value" class="translate">Target-Value</th>
							<th data-buttons="up down delete" style="width:150px;"></th>
						</tr>
					</thead>
					<tbody style="overflow: auto;"></tbody>
				</table>
			</div>
		</div>
	</div>
	<br>
	<div class="row">
		<div class="input-field col s12 m12 l12">
			<input type="checkbox" class="enableOnChange" data-field="showOnlyTargetValues">
			<span class="translate">Show only these keys in dropdown-fiels</span>
			<br>
			<span class="translate" style="font-size: 75%;">(otherwise all keys from the value-list are shown in drop-downs)</span>
		</div>
	</div>
</script>

<script type="text/javascript">
	console.log("iQontrol start");

	//Declarations
	var states = {};
	var targetValues = {};

	//Translations
	$.get("adapter/iqontrol/words.js", function(script) {
		let translation = script.substring(script.indexOf('{'), script.length);
		translation = translation.substring(0, translation.lastIndexOf(';'));
		systemDictionary = $.extend(systemDictionary, JSON.parse(translation));
	});

	//Default Settings
	if (typeof defaults !== 'undefined') {
		defaults["iqontrol"] = function (obj, instanceObj) {
			return {
				enabled:     		   	false,
				readonly:    			(obj && obj.native && obj.native.write == false) || (obj && obj.common && obj.common.write == false) || false,
				invert:					false,
				confirm:				false,
				pincode:				"",
				unit:					(obj && obj.common && obj.common.unit) || "",
				unit_zero:				(obj && obj.common && obj.common.unit) || "",
				unit_one:				(obj && obj.common && obj.common.unit) || "",
				min:					(obj && obj.common && typeof obj.common.min !== "undefined" && !isNaN(Number(obj.common.min))) ? Number(obj.common.min) : "",
				max:					(obj && obj.common && typeof obj.common.max !== "undefined" && !isNaN(Number(obj.common.max))) ? Number(obj.common.max) : "",
				step:					"",
				roundDigits:			2,
				timeFormat:				"x",
				timeDisplayFormat:		"dddd, DD.MM.YYYY HH:mm:ss",
				type:					(obj && obj.common && obj.common.type) || "",
				role:					(obj && obj.common && obj.common.role) || "",
				targetValueId:			"",
				states:					(obj && obj.native && obj.native.states) || (obj && obj.common && obj.common.states),
				statesAddInput:			false,
				statesAddInputCaption:	_("Enter other value..."),
				targetValues:			"",
				showOnlyTargetValues: 	false
			};
		}
	}
	
    //Init
	// Create a helper for sortable tables with preserved width of cells  
	var fixHelper = function(e, ui){
		ui.children().each(function(){  
			$(this).width($(this).width()); 			
		});  
		return ui;  
	};
    if (typeof customPostInits !== 'undefined') {
       customPostInits.iqontrol = function ($div, values, instanceObj, type, role) {
			var adapter =  $div.data('adapter');
			console.log("iQontrol init");
			//Add States to tableStates
			if(values.states){
				//--Check format of valueList
				var valueListString = values.states;
				if (typeof valueListString !== "object"){
					if (tryParseJSON(valueListString) == false){
						valueListString = '{"' + valueListString.replace(/;/g, ',').replace(/:/g, '":"').replace(/,/g, '","') + '"}';
						if (tryParseJSON(valueListString) == false) {
							values.states = {};
						} else {
							values.states = tryParseJSON(valueListString);	
						}		
					} else {
						values.states = tryParseJSON(valueListString);	
					}
				}
				for (key in values.states){ 
					if(typeof key != 'undefined') tableStatesAdd(adapter, key, values.states[key]);
				}
				//Make table sortable
				console.log("Make tableStates sortable");
				$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates tbody').sortable({
					helper: fixHelper,
					stop: function( event, ui ) { 
						console.log("Drag ended, start resorting...");
						changeTableStates(adapter); 
						console.log("resorted.");
					},
					axis: "y"
				});
				changeTableStates(adapter);
			}
			$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-button-add').on('click', function(){
				tableStatesAdd(adapter);
			});
			//Add targetValues to tableTargetValues
			if(values.targetValues){
				//--Check format of valueList
				var targetValuesListString = values.targetValues;
				if (typeof targetValuesListString !== "object"){
					if (tryParseJSON(targetValuesListString) == false){
						targetValuesListString = '{"' + targetValuesListString.replace(/;/g, ',').replace(/:/g, '":"').replace(/,/g, '","') + '"}';
						if (tryParseJSON(targetValuesListString) == false) {
							values.targetValues = {};
						} else {
							values.targetValues = tryParseJSON(targetValuesListString);	
						}		
					} else {
						values.targetValues = tryParseJSON(targetValuesListString);	
					}
				}
				for (key in values.targetValues){ 
					if(typeof key != 'undefined') tableTargetValuesAdd(adapter, key, values.targetValues[key].targetValue, values.targetValues[key].targetDatapointId);
				}
				//Make table sortable
				console.log("Make tableTargetValues sortable");
				$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues tbody').sortable({
					helper: fixHelper,
					stop: function( event, ui ) { 
						console.log("Drag ended, start resorting...");
						changeTableTargetValues(adapter); 
						console.log("resorted.");
					},
					axis: "y"
				});	
				changeTableTargetValues(adapter);
			}
			$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-button-add').on('click', function(){
				tableTargetValuesAdd(adapter);
			});
			//Templates
			$('.template').on('change', function(){
				$('.hasTemplate[data-field="' + $(this).data('template-field') + '"]').val($(this).val());	
			});
			$('.hasTemplate').on('change', function(){
				$('.template[data-template-field="' + $(this).data('field') + '"]').val($(this).val()).select();	
			});
			setTimeout(function(){ $('.hasTemplate').trigger('change'); }, 100);
			//Enable onChange
			$('.enableOnChange').on('change', function(){
				$('#tab-customs-settings li[data-adapter="' + adapter + '"] input[data-field="enabled"]').prop("checked", true);			
			});
			$('#dialog-customs .btn-save').on('click', function(){ 
				if($('#tab-customs-settings li[data-adapter="' + adapter + '"] input[data-field="enabled"]').is(":checked")){
					(function(){ //Closure--> (everything declared inside keeps its value as ist is at the time the function is created)
						var _currentId = gMain.navigateGetParams();
						var _currentObj = gMain.objects[_currentId];
						var _adapter = adapter;
						var _states = states[_adapter];
						var _targetValues = targetValues[_adapter];
						setTimeout(function(){
							if (typeof _currentObj.common.custom == 'undefined') _currentObj.common.custom = {};
							if (typeof _currentObj.common.custom[_adapter] == 'undefined') _currentObj.common.custom[_adapter] = {};
							_currentObj.common.custom[_adapter].states = _states;
							_currentObj.common.custom[_adapter].targetValues = _targetValues;
							gMain.socket.emit('setObject', _currentId, _currentObj, function(err){
								if(err) alert("Errir saving Object");
							});
						}, 100);	
					})(); //<--End Closure
				}
			}); 
        }
    }
	//Table States
	function tableStatesAdd(adapter, key, value){
		key = key || "";
		value = value || "";
		var $table = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-values tbody');
		var line = $table.data('lines') || 0;
		var tableLine = "<tr class='table-line'  data-instance='" + adapter + "' data-line='" + line + "'>";
		tableLine += "		<td><input type='text' class='table-input key' data-instance='" + adapter + "' data-line='" + line + "' name='" + adapter + "_tableStates_line" + line + "_key' id='" + adapter + "_tableStates_line" + line + "_key' value='" + key + "' /></td>";
		tableLine += "		<td><input type='text' class='table-input value' data-instance='" + adapter + "' data-line='" + line + "' name='" + adapter + "_tableStates_line" + line + "_value' id='" + adapter + "_tableStates_line" + line + "_value' value='" + value + "' /></td>";
		tableLine += "		<td><button title='Delete' data-line='" + line + "' class='translateT table-button-delete btn-floating waves-effect waves-light btn-small red' id='" + adapter + "_tableStates_line" + line + "_delete'><i class='material-icons'>delete</i></button><button title='Sort' class='waves-effect waves-light btn-small btn-flat disabled'><i class='material-icons'>drag_handle</i></button></td>";		
		tableLine += "</tr>";
		$table.append(tableLine);
		$table.data('lines', line + 1);
		$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-button-delete').off('click').on('click', function(){
			var line = $(this).data('line');
			$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-line[data-line="' + line + '"').remove();
			changeTableStates(adapter);
		});
		$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-input').off('focusout').on('focusout', function(){changeTableStates(adapter);});
	}
	function changeTableStates(adapter){
		var $lines = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-line');
		states[adapter] = {};
		$lines.each(function(index){
			var line = $(this).data('line');
			var key = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-input.key[data-line="' + line + '"]').val();
			var value = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableStates .table-input.value[data-line="' + line + '"]').val();
			if(key != "") states[adapter][key] = value;
		});
		console.log("changeTableStates: " + JSON.stringify(states[adapter]));
		$('#tab-customs-settings li[data-adapter="' + adapter + '"] input[data-field="enabled"]').prop("checked", true).trigger('change');  //to enable Save-Button
	}

	//Table TargetValues
	function tableTargetValuesAdd(adapter, key, targetValue, targetDatapointId){
		key = key || "";
		targetValue = targetValue || "";
		targetDatapointId = targetDatapointId || "";
		var $table = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-values');
		var line = $table.data('lines') || 0;
		var tableLine = "<tr class='table-line'  data-instance='" + adapter + "' data-line='" + line + "'>";
		tableLine += "		<td><input type='text' class='table-input key' data-instance='" + adapter + "' data-line='" + line + "' name='" + adapter + "_tableTargetValues_line" + line + "_key' id='" + adapter + "_tableTargetValues_line" + line + "_key' value='" + key + "' /></td>";
		tableLine += "		<td><input type='text' class='table-input targetDatapointId' data-instance='" + adapter + "' data-line='" + line + "' name='" + adapter + "_tableTargetValues_line" + line + "_value' id='" + adapter + "_tableTargetValues_line" + line + "_value' value='" + targetDatapointId + "' /></td>";
		tableLine += "		<td><input type='text' class='table-input targetValue' data-instance='" + adapter + "' data-line='" + line + "' name='" + adapter + "_tableTargetValues_line" + line + "_value' id='" + adapter + "_tableTargetValues_line" + line + "_value' value='" + targetValue + "' /></td>";
		tableLine += "		<td><button title='Delete' data-line='" + line + "' class='translateT table-button-delete btn-floating waves-effect waves-light btn-small red' id='" + adapter + "_tableTargetValues_line" + line + "_delete'><i class='material-icons'>delete</i></button><button title='Sort' class='waves-effect waves-light btn-small btn-flat disabled'><i class='material-icons'>drag_handle</i></button></td>";		
		tableLine += "</tr>";
		$table.append(tableLine);
		$table.data('lines', line + 1);
		$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-button-delete').off('click').on('click', function(){
			var line = $(this).data('line');
			$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-line[data-line="' + line + '"').remove();
			changeTableTargetValues(adapter);
		});
		$('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-input').off('focusout').on('focusout', function(){changeTableTargetValues(adapter);});
	}
	function changeTableTargetValues(adapter){
		var $lines = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-line');
		targetValues[adapter] = {};
		$lines.each(function(index){
			var line = $(this).data('line');
			var key = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-input.key[data-line="' + line + '"]').val();
			var targetDatapointId = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-input.targetDatapointId[data-line="' + line + '"]').val();
			var targetValue = $('#tab-customs-settings li[data-adapter="' + adapter + '"] .tableTargetValues .table-input.targetValue[data-line="' + line + '"]').val();
			if(key != "") targetValues[adapter][key] = {targetValue: targetValue, targetDatapointId: targetDatapointId};
		});
		console.log("changeTableTargetValues: " + JSON.stringify(targetValues[adapter]));
		$('#tab-customs-settings li[data-adapter="' + adapter + '"] input[data-field="enabled"]').prop("checked", true).trigger('change');  //to enable Save-Button
	}

	function tryParseJSON(jsonString){ //Returns parsed object or false, if jsonString is not valid
		try {
			var o = JSON.parse(jsonString);
			// Handle non-exception-throwing cases:
			// Neither JSON.parse(false) or JSON.parse(1234) throw errors, hence the type-checking,
			// but... JSON.parse(null) returns null, and typeof null === "object",
			// so we must check for that, too. Thankfully, null is falsey, so this suffices:
			if (o && typeof o === "object") {
				return o;
			}
		}
		catch (e) { }
		return false;
	};

	//OnSave - For future use with newer admin-versions
	//if (typeof customPostOnSave !== 'undefined') {
	//	customPostOnSave.iqontrol = function ($div, instance) {
	//		var adapter =  $div.data('adapter');
	//	};
	//}
</script>